name: 2PR JSON Check

on:
  workflow_run:
    workflows: ["PR Data Path Check"]
    types:
      - completed
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: read

jobs:
  check-json:
    if: |
      github.event.workflow_run.conclusion == 'success' ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: JSON validation
        uses: actions/github-script@v7
        with:
          script: |
            const validLabel = "ÊúâÊïà JSON";
            const invalidLabel = "Êó†Êïà JSON";
            const requiredLabels = ["ÂèãÈìæ", "ËµûÂä©"];

            async function checkPR(prNumber) {

              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
              });

              const currentLabels = pr.data.labels.map(l => l.name);

              // Âè™Ê£ÄÊü•Â∏¶Êúâ ÂèãÈìæ Êàñ ËµûÂä© ÁöÑ PR
              if (!currentLabels.some(l => requiredLabels.includes(l))) {
                console.log(`PR #${prNumber} skipped (no required tag)`);
                return;
              }

              console.log(`Checking PR #${prNumber}`);

              const files = await github.paginate(
                github.rest.pulls.listFiles,
                {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                }
              );

              let hasJsonFile = false;
              let allValid = true;

              for (const file of files) {
                if (file.status === "removed") continue;

                if (file.filename.endsWith(".json")) {
                  hasJsonFile = true;

                  try {
                    const content = await github.rest.repos.getContent({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      path: file.filename,
                      ref: pr.data.head.sha
                    });

                    const buff = Buffer.from(content.data.content, 'base64');
                    const text = buff.toString('utf8');

                    JSON.parse(text);
                    console.log(`${file.filename} ‚úÖ valid`);
                  } catch (e) {
                    console.log(`${file.filename} ‚ùå invalid`);
                    allValid = false;
                  }
                }
              }

              // üî• ÂÖ≥ÈîÆ‰øÆÊîπÔºö
              // Ê≤°Êúâ JSON Êñá‰ª∂Áõ¥Êé•ËßÜ‰∏∫Êó†Êïà
              if (!hasJsonFile) {
                console.log("No JSON files changed ‚Üí mark as invalid");
                allValid = false;
              }

              // Âà†Èô§ÊóßÁä∂ÊÄÅÊ†áÁ≠æ
              for (const label of [validLabel, invalidLabel]) {
                if (currentLabels.includes(label)) {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: prNumber,
                    name: label,
                  });
                }
              }

              // Ê∑ªÂä†Êñ∞Ê†áÁ≠æ
              const labelToAdd = allValid ? validLabel : invalidLabel;

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: [labelToAdd],
              });

              console.log(`Added label ${labelToAdd} to PR #${prNumber}`);
            }

            if (context.eventName === "workflow_dispatch") {

              const prs = await github.paginate(
                github.rest.pulls.list,
                {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: "open",
                }
              );

              for (const pr of prs) {
                await checkPR(pr.number);
              }

            } else {

              const prNumber = context.payload.workflow_run.pull_requests[0]?.number;

              if (prNumber) {
                await checkPR(prNumber);
              } else {
                console.log("No PR associated with this workflow_run.");
              }

            }
