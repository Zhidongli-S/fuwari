name: Friend / Sponsor Auto Verify

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  verify:
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------
      # PR 基础校验阶段
      # ---------------------------
      - name: Base Validation
        if: github.event_name == 'pull_request'
        id: base
        run: |
          git fetch origin ${{ github.base_ref }}
          CHANGED=$(git diff --name-status origin/${{ github.base_ref }}...HEAD)

          echo "$CHANGED"

          COUNT=$(echo "$CHANGED" | wc -l)
          if [ "$COUNT" -ne 1 ]; then
            echo "❌ 仅允许新增一个文件"
            exit 1
          fi

          STATUS=$(echo "$CHANGED" | awk '{print $1}')
          FILE=$(echo "$CHANGED" | awk '{print $2}')

          if [ "$STATUS" != "A" ]; then
            echo "❌ 仅允许新增文件"
            exit 1
          fi

          if [[ ! "$FILE" =~ ^src/data/(friends|sponsors)/ ]]; then
            echo "❌ 只能修改 friends 或 sponsors 目录"
            exit 1
          fi

          if [[ "$FILE" != *.json ]]; then
            echo "❌ 文件必须为 .json"
            exit 1
          fi

          jq empty "$FILE" || { echo "❌ JSON 格式错误"; exit 1; }

          NAME=$(jq -r '.name' "$FILE")
          URL=$(jq -r '.url' "$FILE")
          AVATAR=$(jq -r '.avatar' "$FILE")

          if [ -z "$NAME" ] || [ "$NAME" = "null" ]; then
            echo "❌ 缺少 name"
            exit 1
          fi

          if [[ ! "$URL" =~ ^https?:// ]]; then
            echo "❌ URL 必须为 http/https"
            exit 1
          fi

          if [[ ! "$AVATAR" =~ ^https?:// ]]; then
            echo "❌ avatar 必须为 http/https"
            exit 1
          fi

          echo "file=$FILE" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "avatar=$AVATAR" >> $GITHUB_OUTPUT
          echo "sha=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT

      # ---------------------------
      # URL 检测（允许 10 次跳转）
      # ---------------------------
      - name: Check URL reachable
        if: github.event_name == 'pull_request'
        run: |
          STATUS=$(curl -L -o /dev/null \
            --max-time 15 \
            --connect-timeout 5 \
            --max-redirs 10 \
            -w "%{http_code}" \
            "${{ steps.base.outputs.url }}")

          if [[ "$STATUS" -lt 200 || "$STATUS" -ge 400 ]]; then
            echo "❌ URL 不可达"
            exit 1
          fi

      - name: Check Avatar reachable
        if: github.event_name == 'pull_request'
        run: |
          STATUS=$(curl -L -o /dev/null \
            --max-time 15 \
            --connect-timeout 5 \
            --max-redirs 10 \
            -w "%{http_code}" \
            "${{ steps.base.outputs.avatar }}")

          if [[ "$STATUS" -lt 200 || "$STATUS" -ge 400 ]]; then
            echo "❌ Avatar 不可达"
            exit 1
          fi

      # ---------------------------
      # 更新 PR 标题
      # ---------------------------
      - name: Update PR title
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const file = "${{ steps.base.outputs.file }}"
            const name = "${{ steps.base.outputs.name }}"
            let title = file.includes("friends")
              ? `友链：${name}`
              : `赞助：${name}`

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              title
            })

      # ---------------------------
      # 生成验证挑战
      # ---------------------------
      - name: Create ownership challenge
        if: github.event_name == 'pull_request'
        id: challenge
        run: |
          TOKEN=$(openssl rand -hex 6)
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Comment Challenge
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const token = "${{ steps.challenge.outputs.token }}"
            const sha = "${{ steps.base.outputs.sha }}"
            const url = "${{ steps.base.outputs.url }}"

            const body = `
基础检查已通过。

请完成所有权验证：

在你的网站创建：

${url}/${token}.txt

文件内容必须为：

${sha}

完成后请回复本 PR 任意内容触发验证。
（此 token 永久有效）
`

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            })

      # ---------------------------
      # 所有权验证阶段
      # ---------------------------
      - name: Ownership Verification
        if: github.event_name == 'issue_comment'
        run: |
          PR_NUMBER=${{ github.event.issue.number }}

          AUTHOR=$(gh pr view $PR_NUMBER --json author -q .author.login)
          COMMENTER=${{ github.event.comment.user.login }}

          if [ "$AUTHOR" != "$COMMENTER" ]; then
            echo "❌ 只有 PR 作者可以触发验证"
            exit 1
          fi

          TOKEN=$(gh api repos/${{ github.repository }}/issues/$PR_NUMBER/comments \
            --jq '.[] | select(.body | contains(".txt")) | .body' \
            | grep -oE '[a-f0-9]{12}' | head -n1)

          if [ -z "$TOKEN" ]; then
            echo "❌ 未找到 token"
            exit 1
          fi

          FILE=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          URL=$(jq -r '.url' $FILE)
          SHA=$(gh pr view $PR_NUMBER --json headRefOid -q .headRefOid)

          VERIFY_URL="${URL}/${TOKEN}.txt"

          RESPONSE=$(curl -L -s --max-redirs 5 --max-time 10 "$VERIFY_URL")

          if [ "$RESPONSE" != "$SHA" ]; then
            echo "❌ 所有权验证失败"
            exit 1
          fi

      - name: Mark Verified
        if: success() && github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ["ownership-verified"]
            })
